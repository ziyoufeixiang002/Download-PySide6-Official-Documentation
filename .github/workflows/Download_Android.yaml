name: Download Android Developer Website Mirror

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月第一天运行一次

env:
  WEBSITE_URL: 'https://developer.android.google.cn'
  WEBSITE_START_URL: 'https://developer.android.google.cn/?hl=zh-cn'

jobs:
  download-website:
    name: Download Android Developer Website
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install wget and httrack
      run: |
        sudo apt-get update
        sudo apt-get install -y wget httrack
        
    - name: Download complete website using wget
      run: |
        # 创建输出目录
        mkdir -p android-developer-website
        
        # 使用wget完整镜像整个网站，保留JS和CSS
        wget --mirror \
             --convert-links \
             --adjust-extension \
             --page-requisites \
             --no-parent \
             --no-host-directories \
             --restrict-file-names=windows \
             --reject-regex=".*\.(svg|png|jpg|jpeg|gif|ico|bmp|webp|tiff|psd|ai|eps|raw|mp4|avi|mov|wmv|flv|mkv|webm|m4v|mpg|mpeg|3gp|mp3|wav|flac|aac|ogg|wma|m4a|aiff|pcm|midi)$" \
             --wait=2 \
             --random-wait \
             --limit-rate=1M \
             --timeout=60 \
             --tries=5 \
             -e robots=off \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             --directory-prefix=android-developer-website \
             --level=5 \
             --span-hosts \
             --domains=developer.android.google.cn \
             "$WEBSITE_START_URL" || echo "wget镜像完成或有部分错误"
        
        echo "Android开发者网站下载完成"
        
    - name: Use HTTrack for comprehensive mirroring
      run: |
        # 使用HTTrack进行更完整的镜像
        httrack "$WEBSITE_START_URL" \
          -O android-developer-httrack \
          -%v \
          -r10 \
          -s0 \
          -#L1000000 \
          -*.png *.jpg *.gif *.svg \
          +*.html +*.js +*.css \
          -ad.doubleclick.net/* \
          -www.google-analytics.com/* \
          -F "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          %u || echo "httrack镜像完成"
        
    - name: Create index page
      run: |
        # 创建简单的索引页面
        cat > android-developer-website/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Android Developer Website Mirror</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                ul { list-style-type: none; padding: 0; }
                li { margin: 10px 0; }
                a { text-decoration: none; color: #0066cc; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>Android Developer Website Mirror</h1>
            <p>离线镜像下载于: $(date)</p>
            <p><a href="./">查看完整网站</a></p>
            <p><em>Note: This is a mirror of the Android Developer website with JS and CSS preserved.</em></p>
            <p><strong>Filtered resources:</strong> Images, videos, audio files and icons have been excluded to reduce download size.</p>
        </body>
        </html>
        EOF
        
    - name: Archive downloaded website
      uses: actions/upload-artifact@v4
      with:
        name: android-developer-website-mirror
        path: |
          android-developer-website/
          android-developer-httrack/
        retention-days: 90
        
    - name: Create website summary
      run: |
        echo "### Android 开发者官网镜像下载摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载日期:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**网站地址:** ${{ env.WEBSITE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**起始页面:** ${{ env.WEBSITE_START_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载内容:**" >> $GITHUB_STEP_SUMMARY
        echo "- Android 开发者官网完整镜像（中文版）" >> $GITHUB_STEP_SUMMARY
        echo "- 包括所有文档、指南、API参考等" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载方法:**" >> $GITHUB_STEP_SUMMARY
        echo "- wget完整镜像（递归深度5层）" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack专业镜像工具（备用）" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**保留的资源:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML文件" >> $GITHUB_STEP_SUMMARY
        echo "- JavaScript文件 (JS)" >> $GITHUB_STEP_SUMMARY
        echo "- 样式表文件 (CSS)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**过滤的资源:**" >> $GITHUB_STEP_SUMMARY
        echo "- 图片文件: svg, png, jpg, jpeg, gif, ico, bmp, webp, tiff, psd, ai, eps, raw" >> $GITHUB_STEP_SUMMARY
        echo "- 视频文件: mp4, avi, mov, wmv, flv, mkv, webm, m4v, mpg, mpeg, 3gp" >> $GITHUB_STEP_SUMMARY
        echo "- 音频文件: mp3, wav, flac, aac, ogg, wma, m4a, aiff, pcm, midi" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载设置:**" >> $GITHUB_STEP_SUMMARY
        echo "- 递归深度: 5层（避免下载过多外部链接）" >> $GITHUB_STEP_SUMMARY
        echo "- 超时时间: 60秒" >> $GITHUB_STEP_SUMMARY
        echo "- 重试次数: 5次" >> $GITHUB_STEP_SUMMARY
        echo "- 限速: 1MB/s" >> $GITHUB_STEP_SUMMARY
        echo "- 域名限制: 仅下载 developer.android.google.cn 域名下的内容" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 统计下载的文件数量
        echo "**文件统计:**" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像HTML文件: $(find android-developer-website -name '*.html' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像JS文件: $(find android-developer-website -name '*.js' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像CSS文件: $(find android-developer-website -name '*.css' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像总文件数: $(find android-developer-website -type f | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像目录大小: $(du -sh android-developer-website | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像HTML文件: $(find android-developer-httrack -name '*.html' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像JS文件: $(find android-developer-httrack -name '*.js' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像CSS文件: $(find android-developer-httrack -name '*.css' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像总文件数: $(find android-developer-httrack -type f | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像目录大小: $(du -sh android-developer-httrack | cut -f1)" >> $GITHUB_STEP_SUMMARY
