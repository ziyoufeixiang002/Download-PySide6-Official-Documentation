name: Kotlin 2.2.21 Stdlib Docs

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # 每周日午夜运行
  workflow_dispatch:
    inputs:
      doc-type:
        description: 'Documentation type'
        required: true
        default: 'html'
        type: choice
        options:
        - html
        - gfm
        - javadoc

env:
  KOTLIN_VERSION: '2.2.21'
  GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g'

jobs:
  multi-platform-docs:
    name: Generate Multiplatform Docs
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        target: [ 'jvm', 'js', 'native', 'wasm' ]
        include:
          - target: jvm
            task: 'dokkaHtml'
          - target: js
            task: 'dokkaHtml'
          - target: native
            task: 'dokkaHtml'
          - target: wasm  
            task: 'dokkaHtml'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.8'

    - name: Build documentation for ${{ matrix.target }}
      run: |
        ./gradlew :kotlin-stdlib-${{ matrix.target }}:${{ matrix.task }} \
          -Pkotlin.version=${{ env.KOTLIN_VERSION }} \
          --no-daemon \
          --stacktrace \
          --build-cache

    - name: Upload ${{ matrix.target }} documentation
      uses: actions/upload-artifact@v4
      with:
        name: docs-${{ matrix.target }}-${{ github.sha }}
        path: |
          **/build/dokka/html/**
        retention-days: 30
        compression-level: 9

  aggregate-docs:
    name: Aggregate Documentation
    runs-on: ubuntu-latest
    needs: multi-platform-docs
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all documentation artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./all-docs
        pattern: docs-*-*
        merge-multiple: true

    - name: Create aggregated documentation index
      run: |
        mkdir -p aggregated-docs
        cat > aggregated-docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kotlin ${{ env.KOTLIN_VERSION }} Standard Library Documentation</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                .platform { margin: 20px 0; padding: 15px; border-left: 4px solid #007ec6; background: #f5f5f5; }
                a { color: #007ec6; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>Kotlin ${{ env.KOTLIN_VERSION }} Standard Library Documentation</h1>
            <div class="platform">
                <h2>Available Platforms:</h2>
                <ul>
                <li><a href="jvm/index.html">JVM Documentation</a></li>
                <li><a href="js/index.html">JavaScript Documentation</a></li>
                <li><a href="native/index.html">Native Documentation</a></li>
                <li><a href="wasm/index.html">Wasm Documentation</a></li>
                </ul>
            </div>
            <p>Generated on: $(date)</p>
        </body>
        </html>
        EOF

        # 移动各平台文档到对应目录
        for platform in jvm js native wasm; do
          if [ -d "all-docs/docs-$platform-${{ github.sha }}" ]; then
            mv "all-docs/docs-$platform-${{ github.sha }}" "aggregated-docs/$platform"
          fi
        done

    - name: Upload aggregated documentation
      uses: actions/upload-artifact@v4
      with:
        name: aggregated-kotlin-docs-${{ github.sha }}
        path: ./aggregated-docs
        retention-days: 30

  quality-check:
    name: Documentation Quality Check
    runs-on: ubuntu-latest
    needs: aggregate-docs
    
    steps:
    - name: Download aggregated documentation
      uses: actions/download-artifact@v4
      with:
        pattern: aggregated-kotlin-docs-*
        merge-multiple: true

    - name: Run documentation quality checks
      run: |
        # 检查基本文件结构
        find . -name "*.html" | wc -l
        find . -name "index.html" | head -5
        
        # 检查文件大小（确保文档生成完整）
        du -sh ./*

    - name: Archive documentation coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: documentation-coverage-report
        path: |
          **/build/reports/dokka/**
        retention-days: 7
