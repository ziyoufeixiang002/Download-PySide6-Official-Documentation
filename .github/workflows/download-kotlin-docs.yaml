name: Download Kotlin Complete Website

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月第一天运行一次

env:
  KOTLIN_VERSION: '1.9.0'
  WEBSITE_URL: 'https://kotlinlang.org'

jobs:
  download-documentation:
    name: Download Kotlin Complete Website
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install wget and httrack
      run: |
        sudo apt-get update
        sudo apt-get install -y wget httrack
        
    - name: Download complete Kotlin website using wget
      run: |
        # 创建输出目录
        mkdir -p kotlin-website
        
        # 使用wget完整镜像整个kotlinlang.org网站
        wget --mirror \
             --convert-links \
             --adjust-extension \
             --page-requisites \
             --no-parent \
             --no-host-directories \
             --restrict-file-names=windows \
             --reject-regex=".*\.(svg|png|jpg|jpeg|gif|ico|bmp|webp|tiff|psd|ai|eps|raw|mp4|avi|mov|wmv|flv|mkv|webm|m4v|mpg|mpeg|3gp|mp3|wav|flac|aac|ogg|wma|m4a|aiff|pcm|midi)$" \
             --wait=1 \
             --random-wait \
             --limit-rate=1M \
             --timeout=60 \
             --tries=5 \
             -e robots=off \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             --directory-prefix=kotlin-website \
             --level=inf \
             --reject-regex=".*\.(js|css).*" \
             "$WEBSITE_URL" || echo "wget镜像完成或有部分错误"
        
        echo "Kotlin完整网站下载完成"
        
    - name: Use HTTrack for comprehensive mirroring
      run: |
        # 使用HTTrack进行更完整的镜像（可选，作为备份方法）
        httrack "$WEBSITE_URL" \
          -O kotlin-httrack \
          -%v \
          -r10 \
          -s0 \
          -#L1000000 \
          -*.png *.jpg *.gif *.svg *.js *.css \
          +*.html \
          -ad.doubleclick.net/* \
          -www.google-analytics.com/* \
          -F "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          %u || echo "httrack镜像完成"
        
    - name: Create index page
      run: |
        # 创建简单的索引页面
        cat > kotlin-website/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kotlin $KOTLIN_VERSION Complete Website Mirror</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                ul { list-style-type: none; padding: 0; }
                li { margin: 10px 0; }
                a { text-decoration: none; color: #0066cc; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>Kotlin $KOTLIN_VERSION Complete Website Mirror</h1>
            <p>离线镜像下载于: $(date)</p>
            <ul>
                <li><a href="docs/home.html">Kotlin 文档</a></li>
                <li><a href="api/latest/jvm/stdlib/index.html">Kotlin API 参考</a></li>
                <li><a href="community.html">社区</a></li>
                <li><a href="events.html">活动</a></li>
                <li><a href="blog/index.html">博客</a></li>
            </ul>
            <p><em>Note: This is a complete mirror of the Kotlin website.</em></p>
            <p><strong>Filtered resources:</strong> Images, videos, audio files, icons, JS and CSS have been excluded to reduce download size.</p>
        </body>
        </html>
        EOF
        
    - name: Archive downloaded website
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-complete-website
        path: |
          kotlin-website/
          kotlin-httrack/
        retention-days: 90
        
    - name: Create website summary
      run: |
        echo "### Kotlin 完整网站镜像下载摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载日期:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Kotlin 版本:** ${{ env.KOTLIN_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**网站地址:** ${{ env.WEBSITE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载内容:**" >> $GITHUB_STEP_SUMMARY
        echo "- Kotlin 完整官方网站镜像" >> $GITHUB_STEP_SUMMARY
        echo "- 包括文档、API、博客、社区等所有内容" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载方法:**" >> $GITHUB_STEP_SUMMARY
        echo "- wget完整镜像（递归深度无限）" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack专业镜像工具（备用）" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**过滤的资源:**" >> $GITHUB_STEP_SUMMARY
        echo "- 图片文件: svg, png, jpg, jpeg, gif, ico, bmp, webp, tiff, psd, ai, eps, raw" >> $GITHUB_STEP_SUMMARY
        echo "- 视频文件: mp4, avi, mov, wmv, flv, mkv, webm, m4v, mpg, mpeg, 3gp" >> $GITHUB_STEP_SUMMARY
        echo "- 音频文件: mp3, wav, flac, aac, ogg, wma, m4a, aiff, pcm, midi" >> $GITHUB_STEP_SUMMARY
        echo "- JS和CSS文件: js, css" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载设置:**" >> $GITHUB_STEP_SUMMARY
        echo "- 递归深度: 无限（下载所有链接）" >> $GITHUB_STEP_SUMMARY
        echo "- 超时时间: 60秒" >> $GITHUB_STEP_SUMMARY
        echo "- 重试次数: 5次" >> $GITHUB_STEP_SUMMARY
        echo "- 限速: 1MB/s" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 统计下载的文件数量
        echo "**文件统计:**" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像HTML文件: $(find kotlin-website -name '*.html' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像总文件数: $(find kotlin-website -type f | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像目录大小: $(du -sh kotlin-website | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像HTML文件: $(find kotlin-httrack -name '*.html' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像总文件数: $(find kotlin-httrack -type f | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- HTTrack镜像目录大小: $(du -sh kotlin-httrack | cut -f1)" >> $GITHUB_STEP_SUMMARY
