name: Download Kotlin Official Documentation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月第一天运行一次

env:
  KOTLIN_VERSION: '1.9.0'  # 可根据需要调整版本
  DOCS_BASE_URL: 'https://kotlinlang.org/docs'

jobs:
  download-documentation:
    name: Download Kotlin Docs
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install wget
      run: sudo apt-get update && sudo apt-get install -y wget
        
    - name: Download Kotlin documentation using wget
      run: |
        # 创建输出目录
        mkdir -p kotlin-docs
        
        # 使用wget进行聚焦镜像，只下载Kotlin相关内容
        wget --mirror \
             --convert-links \
             --adjust-extension \
             --page-requisites \
             --no-parent \
             --no-host-directories \
             --restrict-file-names=windows \
             --reject-regex=".*\.(svg|png|jpg|jpeg|gif|ico|bmp|webp|tiff|psd|ai|eps|raw|mp4|avi|mov|wmv|flv|mkv|webm|m4v|mpg|mpeg|3gp|mp3|wav|flac|aac|ogg|wma|m4a|aiff|pcm|midi|js|css)$" \
             --accept-regex=".*kotlinlang\.org/docs.*" \
             --wait=1 \
             --random-wait \
             --limit-rate=1M \
             --timeout=30 \
             --tries=3 \
             -e robots=off \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             --directory-prefix=kotlin-docs \
             --level=3 \
             "https://kotlinlang.org/docs/home.html" || echo "wget镜像完成或有部分错误"
        
        echo "Kotlin文档下载完成"
        
    - name: Create index page
      run: |
        # 创建简单的索引页面
        cat > kotlin-docs/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kotlin $KOTLIN_VERSION Documentation</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                ul { list-style-type: none; padding: 0; }
                li { margin: 10px 0; }
                a { text-decoration: none; color: #0066cc; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>Kotlin $KOTLIN_VERSION Documentation</h1>
            <p>离线文档下载于: $(date)</p>
            <p><a href="docs/home.html">查看完整文档</a></p>
            <p><em>Note: This is a focused mirror containing only Kotlin related documentation.</em></p>
            <p><strong>Filtered resources:</strong> Images, videos, audio files, icons, JS and CSS have been excluded to reduce download size.</p>
        </body>
        </html>
        EOF
        
    - name: Archive downloaded documentation
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-offline-docs
        path: kotlin-docs/
        retention-days: 90
        
    - name: Create documentation summary
      run: |
        echo "### Kotlin 离线文档下载摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载日期:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Kotlin 版本:** ${{ env.KOTLIN_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**源网址:** ${{ env.DOCS_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载方法:**" >> $GITHUB_STEP_SUMMARY
        echo "- wget聚焦镜像（只下载Kotlin相关内容）" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**过滤的资源:**" >> $GITHUB_STEP_SUMMARY
        echo "- 图片文件: svg, png, jpg, jpeg, gif, ico, bmp, webp, tiff, psd, ai, eps, raw" >> $GITHUB_STEP_SUMMARY
        echo "- 视频文件: mp4, avi, mov, wmv, flv, mkv, webm, m4v, mpg, mpeg, 3gp" >> $GITHUB_STEP_SUMMARY
        echo "- 音频文件: mp3, wav, flac, aac, ogg, wma, m4a, aiff, pcm, midi" >> $GITHUB_STEP_SUMMARY
        echo "- JS和CSS文件: js, css" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载设置:**" >> $GITHUB_STEP_SUMMARY
        echo "- 只接受包含 'kotlinlang.org/docs' 的URL" >> $GITHUB_STEP_SUMMARY
        echo "- 递归深度: 3层" >> $GITHUB_STEP_SUMMARY
        echo "- 限速: 1MB/s" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 统计下载的文件数量
        echo "**文件统计:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML文件: $(find kotlin-docs -name '*.html' | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- 总文件数: $(find kotlin-docs -type f | wc -l) 个" >> $GITHUB_STEP_SUMMARY
        echo "- 目录大小: $(du -sh kotlin-docs | cut -f1)" >> $GITHUB_STEP_SUMMARY
