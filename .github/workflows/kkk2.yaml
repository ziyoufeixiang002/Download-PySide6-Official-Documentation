# å·¥ä½œæµåç§°ï¼šé•œåƒ Kotlin å®˜æ–¹ç½‘ç«™ï¼ˆmwget åŠ é€Ÿç‰ˆï¼‰
name: Mirror Kotlin Website - Accelerated

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      exclude_patterns:
        description: 'é¢å¤–æ’é™¤çš„æ–‡ä»¶æ¨¡å¼'
        required: false
        default: '*.tmp,*.bak'
        type: string
      download_threads:
        description: 'ä¸‹è½½çº¿ç¨‹æ•°'
        required: false
        default: '10'
        type: string

  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * 0'

  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # é•œåƒç½‘ç«™ä»»åŠ¡
  mirror-website:
    name: Mirror Kotlinlang.org with mwget
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤2ï¼šå®‰è£…å¿…è¦å·¥å…·ï¼ˆåŒ…æ‹¬ mwgetï¼‰
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget python3-pip build-essential libssl-dev
        # å®‰è£… mwget
        wget http://jaist.dl.sourceforge.net/project/kmphpfm/mwget/0.1/mwget_0.1.0.orig.tar.gz
        tar -xzf mwget_0.1.0.orig.tar.gz
        cd mwget-0.1.0
        ./configure
        make
        sudo make install
        cd ..
        
        # æ›¿ä»£æ–¹æ¡ˆï¼šå¦‚æœä¸Šè¿°å®‰è£…å¤±è´¥ï¼Œä½¿ç”¨å¤šçº¿ç¨‹ wget æ›¿ä»£æ–¹æ¡ˆ
        pip3 install aria2c
        echo "å·¥å…·å®‰è£…å®Œæˆ"
        
    # æ­¥éª¤3ï¼šåˆ›å»ºé•œåƒç›®å½•
    - name: Create mirror directory
      run: |
        MIRROR_DIR="kotlin-mirror-$(date +%Y%m%d-%H%M%S)"
        mkdir -p $MIRROR_DIR
        echo "MIRROR_DIR=$MIRROR_DIR" >> $GITHUB_ENV
        echo "é•œåƒç›®å½•åˆ›å»º: $MIRROR_DIR"
        
    # æ­¥éª¤4ï¼šä½¿ç”¨ mwget å¤šçº¿ç¨‹é•œåƒç½‘ç«™
    - name: Mirror website with mwget (multi-threaded)
      id: mirror-mwget
      continue-on-error: true  # å¦‚æœ mwget å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
      run: |
        echo "ä½¿ç”¨ mwget è¿›è¡Œå¤šçº¿ç¨‹é•œåƒä¸‹è½½..."
        mwget -n ${{ github.event.inputs.download_threads || '10' }} \
          --mirror \
          --page-requisites \
          --html-extension \
          --convert-links \
          --adjust-extension \
          --no-parent \
          --level=5 \
          --no-clobber \
          --timeout=30 \
          --tries=2 \
          --reject-regex='.*\.(mp4|avi|mov|mkv|wmv|flv|webm|mp3|wav|flac|aac|ogg|wma|jpg|jpeg|png|gif|bmp|tiff|webp|svg|ico|raw|cr2|nef|arw)' \
          --no-check-certificate \
          -e robots=off \
          -P ${{ env.MIRROR_DIR }} \
          https://kotlinlang.org/
        
        echo "mwget ä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤5ï¼šå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨ aria2c åŠ é€Ÿä¸‹è½½
    - name: Fallback mirror with aria2c
      if: steps.mirror-mwget.outcome == 'failure'
      run: |
        echo "mwget å¤±è´¥ï¼Œä½¿ç”¨ aria2c ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ..."
        
        # é¦–å…ˆä½¿ç”¨ wget è·å–ç½‘ç«™åœ°å›¾
        wget --spider --force-html -r -l2 https://kotlinlang.org 2>&1 | grep '^--' | awk '{print $3}' | grep -v '\.\(css\|js\|png\|gif\|jpg\)$' > urls.txt
        
        # ä½¿ç”¨ aria2c å¤šçº¿ç¨‹ä¸‹è½½
        aria2c -i urls.txt \
          -j ${{ github.event.inputs.download_threads || '10' }} \
          --max-connection-per-server=5 \
          --split=5 \
          --dir=${{ env.MIRROR_DIR }} \
          --continue=true \
          --timeout=30 \
          --retry-wait=5 \
          --max-tries=3 \
          --check-certificate=false \
          --user-agent="Mozilla/5.0 (compatible; MirrorBot/1.0)"
        
        echo "aria2c å¤‡ç”¨ä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤6ï¼šæœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨åŸç”Ÿ wget
    - name: Final fallback with standard wget
      if: steps.mirror-mwget.outcome == 'failure'
      run: |
        echo "ä½¿ç”¨æ ‡å‡† wget ä½œä¸ºæœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ..."
        wget \
          --mirror \
          --page-requisites \
          --html-extension \
          --convert-links \
          --adjust-extension \
          --no-parent \
          --level=3 \
          --no-clobber \
          --timeout=30 \
          --tries=2 \
          --reject-regex='.*\.(mp4|avi|mov|mkv|wmv|flv|webm|mp3|wav|flac|aac|ogg|wma|jpg|jpeg|png|gif|bmp|tiff|webp|svg|ico|raw|cr2|nef|arw)' \
          --no-check-certificate \
          -e robots=off \
          -P ${{ env.MIRROR_DIR }} \
          https://kotlinlang.org/
          
        echo "æ ‡å‡† wget ä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤7ï¼šæ˜¾ç¤ºé•œåƒç»Ÿè®¡ä¿¡æ¯
    - name: Display mirror statistics
      run: |
        echo "=== é•œåƒç»Ÿè®¡ä¿¡æ¯ ==="
        echo "é•œåƒç›®å½•: ${{ env.MIRROR_DIR }}"
        echo "ä½¿ç”¨çš„ä¸‹è½½å·¥å…·: $([ -f urls.txt ] && echo 'aria2c' || (which mwget >/dev/null && echo 'mwget' || echo 'wget'))"
        echo "æ€»æ–‡ä»¶æ•°: $(find ${{ env.MIRROR_DIR }} -type f | wc -l)"
        echo "æ€»ç›®å½•æ•°: $(find ${{ env.MIRROR_DIR }} -type d | wc -l)"
        echo "é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        
        # æ˜¾ç¤ºæ–‡ä»¶ç±»å‹åˆ†å¸ƒ
        echo "=== æ–‡ä»¶ç±»å‹åˆ†å¸ƒ ==="
        find ${{ env.MIRROR_DIR }} -type f -name "*.html" | wc -l | xargs echo "HTML æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.css" | wc -l | xargs echo "CSS æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.js" | wc -l | xargs echo "JavaScript æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.pdf" | wc -l | xargs echo "PDF æ–‡ä»¶æ•°:"
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    # æ­¥éª¤8ï¼šæ¸…ç†å’Œä¼˜åŒ–
    - name: Clean up and optimize
      run: |
        # åˆ é™¤ç©ºç›®å½•
        find ${{ env.MIRROR_DIR }} -type d -empty -delete
        
        # å‹ç¼©æ–‡æœ¬æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´
        find ${{ env.MIRROR_DIR }} -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.txt" | head -100 | xargs -I {} gzip -k {}
        
        echo "æ¸…ç†å’Œä¼˜åŒ–å®Œæˆ"
        
    # æ­¥éª¤9ï¼šä¸Šä¼ é•œåƒæ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
    - name: Upload mirror as artifact
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-mirror-accelerated-$(date +%Y%m%d-%H%M%S)
        path: ${{ env.MIRROR_DIR }}
        retention-days: 30
        compression-level: 9

    # æ­¥éª¤10ï¼šæ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: Completion message
      run: |
        echo "âœ… Kotlin ç½‘ç«™é•œåƒä»»åŠ¡å®Œæˆï¼"
        echo "ğŸš€ ä½¿ç”¨å¤šçº¿ç¨‹ä¸‹è½½åŠ é€Ÿ"
        echo "ğŸ“ é•œåƒä¿å­˜åœ¨: ${{ env.MIRROR_DIR }}"
        echo "ğŸ“¦ äº§ç‰©å·²ä¸Šä¼ ï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
        echo "â° æ€»è€—æ—¶: $((SECONDS/60)) åˆ† $((SECONDS%60)) ç§’"
