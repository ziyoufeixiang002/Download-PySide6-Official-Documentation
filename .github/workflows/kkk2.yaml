# å·¥ä½œæµåç§°ï¼šé•œåƒ Kotlin å®˜æ–¹ç½‘ç«™ï¼ˆç¨³å®šç‰ˆï¼‰
name: Mirror Kotlin Website - Stable

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      download_threads:
        description: 'ä¸‹è½½çº¿ç¨‹æ•°'
        required: false
        default: '5'
        type: string

  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * 0'

  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # é•œåƒç½‘ç«™ä»»åŠ¡
  mirror-website:
    name: Mirror Kotlinlang.org Stable
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤2ï¼šå®‰è£…å¿…è¦å·¥å…·
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl python3-pip
        pip3 install requests beautifulsoup4 urllib3
        echo "å·¥å…·å®‰è£…å®Œæˆ"
        
    # æ­¥éª¤3ï¼šåˆ›å»ºé•œåƒç›®å½•
    - name: Create mirror directory
      run: |
        MIRROR_DIR="kotlin-mirror-$(date +%Y%m%d-%H%M%S)"
        mkdir -p $MIRROR_DIR
        echo "MIRROR_DIR=$MIRROR_DIR" >> $GITHUB_ENV
        echo "é•œåƒç›®å½•åˆ›å»º: $MIRROR_DIR"
        
    # æ­¥éª¤4ï¼šä½¿ç”¨ä¼˜åŒ–çš„ wget è¿›è¡Œé•œåƒï¼ˆä¸»è¦æ–¹æ³•ï¼‰
    - name: Mirror with optimized wget
      run: |
        echo "ä½¿ç”¨ä¼˜åŒ–çš„ wget è¿›è¡Œç½‘ç«™é•œåƒ..."
        
        wget \
          --mirror \
          --page-requisites \
          --html-extension \
          --convert-links \
          --adjust-extension \
          --no-parent \
          --level=inf \
          --no-clobber \
          --timeout=60 \
          --tries=3 \
          --waitretry=5 \
          --retry-connrefused \
          --random-wait \
          --limit-rate=2M \
          --reject-regex='.*\.(mp4|avi|mov|mkv|wmv|flv|webm|mp3|wav|flac|aac|ogg|wma|zip|tar|gz|exe|dmg|pkg|deb|rpm)' \
          --accept-regex='.*\.(html|htm|css|js|pdf|txt|md|json|xml|woff|woff2|ttf|eot|svg|ico|png|jpg|jpeg|gif|webp)' \
          --no-check-certificate \
          --restrict-file-names=unix \
          --user-agent="Mozilla/5.0 (compatible; KotlinMirrorBot/1.0)" \
          -e robots=off \
          --directory-prefix=${{ env.MIRROR_DIR }} \
          --no-verbose \
          https://kotlinlang.org/ 2>&1 | tee wget.log
        
        echo "wget é•œåƒå®Œæˆ"
        echo "æ£€æŸ¥ä¸‹è½½æ—¥å¿—..."
        tail -20 wget.log
        
    # æ­¥éª¤5ï¼šåˆ†é˜¶æ®µä¸‹è½½å…³é”®éƒ¨åˆ†
    - name: Download key sections separately
      run: |
        echo "åˆ†é˜¶æ®µä¸‹è½½å…³é”®éƒ¨åˆ†..."
        
        # å®šä¹‰å…³é”®éƒ¨åˆ†
        sections=(
          "docs/reference"
          "docs/tutorials" 
          "api/latest"
          "community"
          "docs/events"
        )
        
        for section in "${sections[@]}"; do
          echo "ä¸‹è½½ç« èŠ‚: $section"
          wget \
            --mirror \
            --page-requisites \
            --html-extension \
            --convert-links \
            --adjust-extension \
            --no-parent \
            --level=2 \
            --timeout=30 \
            --tries=2 \
            --no-check-certificate \
            --directory-prefix=${{ env.MIRROR_DIR }} \
            "https://kotlinlang.org/$section/" || echo "ç« èŠ‚ $section ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª"
        done
        
    # æ­¥éª¤6ï¼šä½¿ç”¨ Python è„šæœ¬è¡¥å……ä¸‹è½½
    - name: Supplemental download with Python
      run: |
        echo "ä½¿ç”¨ Python è„šæœ¬è¿›è¡Œè¡¥å……ä¸‹è½½..."
        
        cat > supplemental_download.py << 'EOF'
        import requests
        import os
        from urllib.parse import urljoin, urlparse
        import time
        
        def download_url(url, save_dir):
            """ä¸‹è½½å•ä¸ªURL"""
            try:
                response = requests.get(url, timeout=15, verify=False)
                response.raise_for_status()
                
                # æ„å»ºä¿å­˜è·¯å¾„
                parsed = urlparse(url)
                path = parsed.path.lstrip('/')
                if not path:
                    path = "index.html"
                elif path.endswith('/'):
                    path += "index.html"
                
                save_path = os.path.join(save_dir, "kotlinlang.org", path)
                os.makedirs(os.path.dirname(save_path), exist_ok=True)
                
                with open(save_path, 'wb') as f:
                    f.write(response.content)
                
                print(f"âœ… ä¸‹è½½æˆåŠŸ: {url}")
                return True
                
            except Exception as e:
                print(f"âŒ ä¸‹è½½å¤±è´¥ {url}: {e}")
                return False
        
        # å…³é”®é¡µé¢åˆ—è¡¨
        critical_pages = [
            "https://kotlinlang.org/",
            "https://kotlinlang.org/docs/home.html",
            "https://kotlinlang.org/docs/reference/",
            "https://kotlinlang.org/docs/tutorials/",
            "https://kotlinlang.org/api/latest/",
            "https://kotlinlang.org/community/",
            "https://kotlinlang.org/docs/events.html"
        ]
        
        save_dir = os.environ.get('MIRROR_DIR', '.')
        success_count = 0
        
        for page in critical_pages:
            if download_url(page, save_dir):
                success_count += 1
            time.sleep(1)  # ç¤¼è²Œå»¶è¿Ÿ
        
        print(f"è¡¥å……ä¸‹è½½å®Œæˆ: {success_count}/{len(critical_pages)} ä¸ªé¡µé¢æˆåŠŸ")
        EOF
        
        python3 supplemental_download.py
        
    # æ­¥éª¤7ï¼šä¿®å¤é“¾æ¥å’Œæ–‡ä»¶ç»“æ„
    - name: Fix links and structure
      run: |
        echo "ä¿®å¤æ–‡ä»¶ç»“æ„å’Œé“¾æ¥..."
        
        # ç¡®ä¿ä¸»é¡µé¢å­˜åœ¨
        if [ ! -f "${{ env.MIRROR_DIR }}/kotlinlang.org/index.html" ]; then
          echo "åˆ›å»ºé»˜è®¤é¦–é¡µ..."
          mkdir -p "${{ env.MIRROR_DIR }}/kotlinlang.org"
          cat > "${{ env.MIRROR_DIR }}/kotlinlang.org/index.html" << 'HTML'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kotlin Documentation Mirror</title>
            <meta charset="utf-8">
        </head>
        <body>
            <h1>Kotlin ç½‘ç«™é•œåƒ</h1>
            <p>è¿™æ˜¯ä¸€ä¸ª Kotlin å®˜æ–¹ç½‘ç«™çš„é•œåƒã€‚</p>
            <p>é•œåƒæ—¶é—´: $(date)</p>
            <ul>
                <li><a href="docs/home.html">Kotlin æ–‡æ¡£</a></li>
                <li><a href="docs/reference/">è¯­è¨€å‚è€ƒ</a></li>
                <li><a href="docs/tutorials/">æ•™ç¨‹</a></li>
            </ul>
        </body>
        </html>
        HTML
        fi
        
    # æ­¥éª¤8ï¼šæ˜¾ç¤ºé•œåƒç»Ÿè®¡ä¿¡æ¯
    - name: Display mirror statistics
      run: |
        echo "=== é•œåƒç»Ÿè®¡ä¿¡æ¯ ==="
        echo "é•œåƒç›®å½•: ${{ env.MIRROR_DIR }}"
        echo "æ€»æ–‡ä»¶æ•°: $(find ${{ env.MIRROR_DIR }} -type f | wc -l)"
        echo "æ€»ç›®å½•æ•°: $(find ${{ env.MIRROR_DIR }} -type d | wc -l)"
        echo "é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        
        # æ–‡ä»¶ç±»å‹ç»Ÿè®¡
        echo "=== æ–‡ä»¶ç±»å‹åˆ†å¸ƒ ==="
        find ${{ env.MIRROR_DIR }} -type f -name "*.html" | wc -l | xargs echo "HTML æ–‡ä»¶:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.css" | wc -l | xargs echo "CSS æ–‡ä»¶:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.js" | wc -l | xargs echo "JavaScript æ–‡ä»¶:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.png" -o -name "*.jpg" -o -name "*.gif" | wc -l | xargs echo "å›¾ç‰‡æ–‡ä»¶:"
        
    # æ­¥éª¤9ï¼šéªŒè¯åŸºæœ¬å®Œæ•´æ€§
    - name: Verify basic integrity
      run: |
        echo "=== åŸºæœ¬å®Œæ•´æ€§éªŒè¯ ==="
        
        required_files=(
          "kotlinlang.org/index.html"
          "kotlinlang.org/docs/home.html"
        )
        
        all_exists=true
        for file in "${required_files[@]}"; do
          if [ -f "${{ env.MIRROR_DIR }}/$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file - ç¼ºå¤±"
            all_exists=false
          fi
        done
        
        if [ "$all_exists" = true ]; then
          echo "âœ… åŸºæœ¬å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        else
          echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶ç¼ºå¤±ï¼Œä½†é•œåƒä»å¯ä½¿ç”¨"
        fi
        
    # æ­¥éª¤10ï¼šæ¸…ç†å’Œä¼˜åŒ–
    - name: Clean up
      run: |
        # åˆ é™¤ç©ºç›®å½•
        find ${{ env.MIRROR_DIR }} -type d -empty -delete
        
        # åˆ é™¤æ—¥å¿—æ–‡ä»¶
        rm -f wget.log supplemental_download.py
        
        # ä¿®å¤æƒé™
        find ${{ env.MIRROR_DIR }} -type f -exec chmod 644 {} \;
        find ${{ env.MIRROR_DIR }} -type d -exec chmod 755 {} \;
        
        echo "æ¸…ç†å®Œæˆ"
        
    # æ­¥éª¤11ï¼šä¸Šä¼ é•œåƒæ–‡ä»¶
    - name: Upload mirror as artifact
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-mirror-stable-$(date +%Y%m%d-%H%M%S)
        path: ${{ env.MIRROR_DIR }}
        retention-days: 30
        compression-level: 9

    # æ­¥éª¤12ï¼šæ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: Completion message
      run: |
        echo "âœ… Kotlin ç½‘ç«™é•œåƒä»»åŠ¡å®Œæˆï¼"
        echo "ğŸ“ é•œåƒç›®å½•: ${{ env.MIRROR_DIR }}"
        echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find ${{ env.MIRROR_DIR }} -type f | wc -l)"
        echo "ğŸ’¾ é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        echo "ğŸ¯ é•œåƒæ—¶é—´: $(date)"
        echo "ğŸ“¦ äº§ç‰©å·²ä¸Šä¼ è‡³ Actions é¡µé¢"
