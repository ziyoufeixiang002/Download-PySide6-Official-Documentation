# å·¥ä½œæµåç§°ï¼šé•œåƒ Kotlin å®˜æ–¹ç½‘ç«™ï¼ˆä¼˜åŒ–åŠ é€Ÿç‰ˆï¼‰
name: Mirror Kotlin Website - Optimized

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      exclude_patterns:
        description: 'é¢å¤–æŽ’é™¤çš„æ–‡ä»¶æ¨¡å¼'
        required: false
        default: '*.tmp,*.bak'
        type: string
      download_threads:
        description: 'ä¸‹è½½çº¿ç¨‹æ•°'
        required: false
        default: '8'
        type: string

  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * 0'

  # æŽ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # é•œåƒç½‘ç«™ä»»åŠ¡
  mirror-website:
    name: Mirror Kotlinlang.org Optimized
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤2ï¼šå®‰è£…çŽ°ä»£ä¸‹è½½å·¥å…·
    - name: Install modern download tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl aria2 python3-pip
        # å®‰è£… httpx å’ŒçŽ°ä»£ Python å·¥å…·
        pip3 install httpx[http2] requests beautifulsoup4 lxml
        echo "å·¥å…·å®‰è£…å®Œæˆ"
        
    # æ­¥éª¤3ï¼šåˆ›å»ºé•œåƒç›®å½•
    - name: Create mirror directory
      run: |
        MIRROR_DIR="kotlin-mirror-$(date +%Y%m%d-%H%M%S)"
        mkdir -p $MIRROR_DIR
        echo "MIRROR_DIR=$MIRROR_DIR" >> $GITHUB_ENV
        echo "é•œåƒç›®å½•åˆ›å»º: $MIRROR_DIR"
        
    # æ­¥éª¤4ï¼šé¦–é€‰æ–¹æ¡ˆ - ä½¿ç”¨ aria2c å¤šçº¿ç¨‹ä¸‹è½½
    - name: Mirror with aria2c (multi-threaded)
      id: mirror-aria2c
      run: |
        echo "ä½¿ç”¨ aria2c è¿›è¡Œå¤šçº¿ç¨‹é•œåƒä¸‹è½½..."
        
        # åˆ›å»ºä¸‹è½½åˆ—è¡¨
        cat > download_script.py << 'EOF'
        import requests
        from bs4 import BeautifulSoup
        import urllib.parse
        import os
        
        def get_sitemap_links(base_url):
            """èŽ·å–ç½‘ç«™åœ°å›¾é“¾æŽ¥"""
            try:
                response = requests.get(base_url, timeout=10)
                soup = BeautifulSoup(response.content, 'html.parser')
                links = set()
                
                # èŽ·å–æ‰€æœ‰é¡µé¢é“¾æŽ¥
                for link in soup.find_all('a', href=True):
                    href = link['href']
                    full_url = urllib.parse.urljoin(base_url, href)
                    if base_url in full_url:
                        links.add(full_url)
                
                return list(links)
            except Exception as e:
                print(f"Error getting sitemap: {e}")
                return [base_url]
        
        base_url = "https://kotlinlang.org"
        links = get_sitemap_links(base_url)
        
        # å†™å…¥ä¸‹è½½åˆ—è¡¨
        with open('urls.txt', 'w') as f:
            for link in links:
                f.write(link + '\n')
                # æ·»åŠ èµ„æºæ–‡ä»¶
                f.write(link + 'css\n')
                f.write(link + 'js\n')
        
        print(f"Generated {len(links)} URLs for download")
        EOF
        
        python3 download_script.py
        
        # ä½¿ç”¨ aria2c å¤šçº¿ç¨‹ä¸‹è½½
        aria2c -i urls.txt \
          -j ${{ github.event.inputs.download_threads || '8' }} \
          --max-connection-per-server=5 \
          --split=5 \
          --dir=${{ env.MIRROR_DIR }} \
          --continue=true \
          --timeout=20 \
          --retry-wait=3 \
          --max-tries=2 \
          --check-certificate=false \
          --user-agent="Mozilla/5.0 (compatible; MirrorBot/1.0)" \
          --file-allocation=none \
          --allow-overwrite=true
        
        echo "aria2c å¤šçº¿ç¨‹ä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤5ï¼šè¡¥å……ä¸‹è½½ - ä½¿ç”¨ wget èŽ·å–å®Œæ•´ç»“æž„
    - name: Supplemental download with wget
      run: |
        echo "ä½¿ç”¨ wget è¡¥å……ä¸‹è½½ï¼Œç¡®ä¿ç½‘ç«™ç»“æž„å®Œæ•´..."
        
        wget \
          --mirror \
          --page-requisites \
          --html-extension \
          --convert-links \
          --adjust-extension \
          --no-parent \
          --level=2 \
          --no-clobber \
          --timeout=20 \
          --tries=2 \
          --reject-regex='.*\.(mp4|avi|mov|mkv|wmv|flv|webm|mp3|wav|flac|aac|ogg|wma)' \
          --no-check-certificate \
          -e robots=off \
          -P ${{ env.MIRROR_DIR }}_supplement \
          https://kotlinlang.org/
        
        # åˆå¹¶è¡¥å……å†…å®¹åˆ°ä¸»é•œåƒç›®å½•
        cp -rn ${{ env.MIRROR_DIR }}_supplement/* ${{ env.MIRROR_DIR }}/ 2>/dev/null || true
        rm -rf ${{ env.MIRROR_DIR }}_supplement
        
        echo "è¡¥å……ä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤6ï¼šä½¿ç”¨ curl è¿›è¡Œå¹¶è¡Œä¸‹è½½ä¼˜åŒ–
    - name: Parallel download with curl
      run: |
        echo "ä½¿ç”¨ curl å¹¶è¡Œä¸‹è½½å…³é”®èµ„æº..."
        
        # åˆ›å»ºå…³é”®èµ„æºåˆ—è¡¨
        cat > critical_urls.txt << 'EOF'
        https://kotlinlang.org/assets/fonts/kotlin.woff2
        https://kotlinlang.org/assets/fonts/kotlin.woff
        https://kotlinlang.org/assets/fonts/kotlin.ttf
        https://kotlinlang.org/assets/styles/main.css
        https://kotlinlang.org/assets/styles/kotlin.css
        https://kotlinlang.org/assets/scripts/main.js
        EOF
        
        # ä½¿ç”¨ xargs å¹¶è¡Œä¸‹è½½
        cat critical_urls.txt | xargs -P 4 -I {} curl -L --connect-timeout 10 --retry 2 --create-dirs -o "${{ env.MIRROR_DIR }}/{}" "{}" || true
        
        echo "å¹¶è¡Œä¸‹è½½å®Œæˆ"
        
    # æ­¥éª¤7ï¼šæ˜¾ç¤ºé•œåƒç»Ÿè®¡ä¿¡æ¯
    - name: Display mirror statistics
      run: |
        echo "=== é•œåƒç»Ÿè®¡ä¿¡æ¯ ==="
        echo "é•œåƒç›®å½•: ${{ env.MIRROR_DIR }}"
        echo "æ€»æ–‡ä»¶æ•°: $(find ${{ env.MIRROR_DIR }} -type f | wc -l)"
        echo "æ€»ç›®å½•æ•°: $(find ${{ env.MIRROR_DIR }} -type d | wc -l)"
        echo "é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        
        # æ˜¾ç¤ºæ–‡ä»¶ç±»åž‹åˆ†å¸ƒ
        echo "=== æ–‡ä»¶ç±»åž‹åˆ†å¸ƒ ==="
        find ${{ env.MIRROR_DIR }} -type f -name "*.html" | wc -l | xargs echo "HTML æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.css" | wc -l | xargs echo "CSS æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.js" | wc -l | xargs echo "JavaScript æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.woff2" | wc -l | xargs echo "Webå­—ä½“æ•°:"
        
        # ä¸‹è½½é€Ÿåº¦è¯„ä¼°
        echo "=== æ€§èƒ½è¯„ä¼° ==="
        echo "ä¸‹è½½çº¿ç¨‹æ•°: ${{ github.event.inputs.download_threads || '8' }}"
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    # æ­¥éª¤8ï¼šä¼˜åŒ–å’Œæ¸…ç†
    - name: Optimize and clean up
      run: |
        # åˆ é™¤ç©ºç›®å½•
        find ${{ env.MIRROR_DIR }} -type d -empty -delete
        
        # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        rm -f urls.txt critical_urls.txt download_script.py
        
        # ä¿®å¤æ–‡ä»¶æƒé™
        find ${{ env.MIRROR_DIR }} -type f -exec chmod 644 {} \;
        find ${{ env.MIRROR_DIR }} -type d -exec chmod 755 {} \;
        
        echo "ä¼˜åŒ–å’Œæ¸…ç†å®Œæˆ"
        
    # æ­¥éª¤9ï¼šéªŒè¯é•œåƒå®Œæ•´æ€§
    - name: Verify mirror integrity
      run: |
        echo "=== é•œåƒå®Œæ•´æ€§éªŒè¯ ==="
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        critical_files=(
          "index.html"
          "docs/reference/index.html"
          "docs/tutorials/index.html"
        )
        
        for file in "${critical_files[@]}"; do
          if [ -f "${{ env.MIRROR_DIR }}/kotlinlang.org/$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âš ï¸  $file ç¼ºå¤±"
          fi
        done
        
        # æ£€æŸ¥é•œåƒæ˜¯å¦åŒ…å«å†…å®¹
        if [ $(find ${{ env.MIRROR_DIR }} -name "*.html" | wc -l) -gt 10 ]; then
          echo "âœ… é•œåƒå®Œæ•´æ€§éªŒè¯é€šè¿‡"
        else
          echo "âŒ é•œåƒå¯èƒ½ä¸å®Œæ•´ï¼ŒHTML æ–‡ä»¶æ•°é‡ä¸è¶³"
        fi
        
    # æ­¥éª¤10ï¼šä¸Šä¼ é•œåƒæ–‡ä»¶ä½œä¸ºæž„å»ºäº§ç‰©
    - name: Upload mirror as artifact
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-mirror-optimized-$(date +%Y%m%d-%H%M%S)
        path: ${{ env.MIRROR_DIR }}
        retention-days: 30
        compression-level: 9

    # æ­¥éª¤11ï¼šæ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: Completion message
      run: |
        echo "âœ… Kotlin ç½‘ç«™é•œåƒä»»åŠ¡å®Œæˆï¼"
        echo "ðŸš€ ä½¿ç”¨å¤šå·¥å…·å¹¶è¡Œä¸‹è½½åŠ é€Ÿ"
        echo "ðŸ“ é•œåƒä¿å­˜åœ¨: ${{ env.MIRROR_DIR }}"
        echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡: $(find ${{ env.MIRROR_DIR }} -type f | wc -l) ä¸ªæ–‡ä»¶"
        echo "ðŸ’¾ é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        echo "ðŸ“¦ äº§ç‰©å·²ä¸Šä¼ ï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
