name: Build PySide6 6.10 Full Documentation (Base + API)

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

permissions:
  contents: read
  actions: write

jobs:
  build-docs:
    runs-on: ubuntu-latest
    env:
      QT_VERSION: "6.10.0"
      QT_SRC_ARCHIVE: "qt-everywhere-src-${{ env.QT_VERSION }}.tar.xz"
      QT_SRC_URL_OFFICIAL: "https://download.qt.io/official_releases/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      QT_SRC_URL_TUNA: "https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      QT_SRC_URL_USTC: "https://mirrors.ustc.edu.cn/qtproject/archive/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      QT_SRC_RELEASE_TAG: "v6.10.0-assets"
      PYSIDE_REPO: "https://github.com/pyside/pyside-setup.git"
      PYSIDE_TAG: "v6.10.0"
      PYTHON_VERSION: "3.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libxml2-dev libxslt1-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            graphviz libgraphviz-dev \
            wget tar xz-utils \
            qt6-base-dev-tools  # ensures qdoc6/qtpaths6 in PATH

      - name: Cache Qt source
        id: cache-qt-src
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_SRC_ARCHIVE }}
          key: qt-src-${{ env.QT_VERSION }}-v3

      - name: Download Qt source (cache â†’ official â†’ mirrors â†’ release)
        if: steps.cache-qt-src.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          ARCHIVE="${{ env.QT_SRC_ARCHIVE }}"
          echo "Qt source not cached. Trying download strategies..."

          # Strategy 1: Official
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_OFFICIAL }}" -O "$ARCHIVE.tmp"; then
            mv "$ARCHIVE.tmp" "$ARCHIVE"
            echo "âœ… Downloaded from official"
            exit 0
          fi

          # Strategy 2: TUNA
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_TUNA }}" -O "$ARCHIVE.tmp"; then
            mv "$ARCHIVE.tmp" "$ARCHIVE"
            echo "âœ… Downloaded from TUNA"
            exit 0
          fi

          # Strategy 3: USTC
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_USTC }}" -O "$ARCHIVE.tmp"; then
            mv "$ARCHIVE.tmp" "$ARCHIVE"
            echo "âœ… Downloaded from USTC"
            exit 0
          fi

          # Strategy 4: Private Release (requires gh CLI)
          if command -v gh >/dev/null && \
             echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token && \
             gh release download "${{ env.QT_SRC_RELEASE_TAG }}" \
                 --repo "$GITHUB_REPOSITORY" \
                 -p "$ARCHIVE" 2>/dev/null; then
            echo "âœ… Downloaded from private release"
            exit 0
          fi

          echo "âŒ All download strategies failed"
          exit 1

      - name: Extract Qt source
        run: |
          mkdir -p qt-src
          echo "Extracting ${{ env.QT_SRC_ARCHIVE }}..."
          tar -xf "${{ env.QT_SRC_ARCHIVE }}" -C qt-src --strip-components=1
          echo "âœ… Qt source extracted."

      - name: Clone PySide6 setup repo
        run: |
          git clone --depth 1 --branch ${{ env.PYSIDE_TAG }} ${{ env.PYSIDE_REPO }} pyside-setup

      - name: Install documentation requirements
        run: |
          cd pyside-setup
          pip install -r requirements-doc.txt

      - name: Set up virtual environment
        run: |
          python -m venv venv-docs
          source venv-docs/bin/activate
          pip install -U pip
          pip install -r pyside-setup/requirements-doc.txt

      - name: Build PySide6 + Documentation
        run: |
          source venv-docs/bin/activate
          cd pyside-setup

          python setup.py build \
            --build-type=all \
            --module-subset=Core,Gui,Widgets \
            --qt-src-dir="${{ github.workspace }}/qt-src" \
            --build-docs \
            --doc-build-online \
            --skip-make-install \
            --skip-packaging \
            --verbose-build

      - name: Build API docs with ninja
        run: |
          source venv-docs/bin/activate
          BUILD_DIR=$(find . -name "build" -type d -not -path "*/\.*" | grep -E "build.*${{ env.PYTHON_VERSION }}" | head -n1 || echo "./build")
          cd "$BUILD_DIR/pyside6" || { echo "âŒ pyside6 build dir not found"; exit 1; }
          ninja apidoc -j $(nproc)

      - name: Collect and package documentation
        run: |
          source venv-docs/bin/activate
          mkdir -p artifacts/{html,qch}

          HTML_DIR=$(find . -path "*/pyside6/doc/html" -type d | head -n1)
          SHIBOKEN_HTML_DIR=$(find . -path "*/shiboken6/doc/html" -type d | head -n1)
          QCH_FILES=$(find . -name "*.qch" -type f)

          [ -n "$HTML_DIR" ] && cp -r "$HTML_DIR"/* artifacts/html/ 2>/dev/null || true
          [ -n "$SHIBOKEN_HTML_DIR" ] && mkdir -p artifacts/html/shiboken6 && cp -r "$SHIBOKEN_HTML_DIR"/* artifacts/html/shiboken6/ 2>/dev/null || true
          [ -n "$QCH_FILES" ] && cp $QCH_FILES artifacts/qch/ 2>/dev/null || true

          cat > artifacts/index.html <<'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PySide6 6.10 Docs</title>
</head>
<body>
  <h1>PySide6 6.10 Full Documentation</h1>
  <ul>
    <li><a href="html/pyside6/index.html">ðŸ“– PySide6 HTML</a></li>
    <li><a href="html/shiboken6/index.html">ðŸ“– Shiboken HTML</a></li>
    <li><a href="qch/">ðŸ“¦ QCH Files</a> (PySide.qch / Shiboken.qch)</li>
  </ul>
  <small>Generated: $(date -u)</small>
</body>
</html>
EOF

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-6.10-docs-full
          path: artifacts/
          retention-days: 30
