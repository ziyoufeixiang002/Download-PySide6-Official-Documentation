name: Build PySide6 Documentation

on:
  workflow_dispatch:  # 允许手动触发
  push:
    tags:
      - 'v*'  # 标签推送时触发
  schedule:
    - cron: '0 0 * * 0'  # 每周日午夜运行一次

env:
  PYTHON_VERSION: '3.10'
  QT_VERSION: '6.10.0'
  PYSIDE_VERSION: '6.10.0'

jobs:
  build-documentation:
    name: Build PySide6 Docs
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: pyside/pyside-setup
        fetch-depth: 0
        ref: 6.10  # 指定使用 6.10 分支
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libxml2-dev \
          libxslt1-dev \
          graphviz \
          libgl1-mesa-dev \
          libxkbcommon-x11-0 \
          libdbus-1-3 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xinput0 \
          libxcb-xfixes0 \
          pkg-config \
          libssl-dev \
          libglib2.0-dev
        
    - name: Create virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        
    - name: Install compatible build tools
      run: |
        source venv/bin/activate
        # 安装兼容版本的构建工具
        pip install --upgrade "pip<23.0"  # 使用稍旧但稳定的pip版本
        pip install "setuptools==68.0.0" "wheel==0.37.0"  # 已知兼容的版本
        
    - name: Install documentation requirements
      run: |
        source venv/bin/activate
        # 先安装基础依赖
        pip install -r requirements.txt
        # 然后安装文档特定依赖
        pip install -r requirements-doc.txt
        
    - name: Download Qt source code
      run: |
        wget https://download.qt.io/official_releases/qt/6.10/$QT_VERSION/single/qt-everywhere-src-$QT_VERSION.tar.xz
        tar -xf qt-everywhere-src-$QT_VERSION.tar.xz
        echo "QT_SRC_DIR=$PWD/qt-everywhere-src-$QT_VERSION" >> $GITHUB_ENV
        
    - name: Configure and build PySide6
      run: |
        source venv/bin/activate
        # 首先运行配置
        python setup.py configure \
          --qt-src-dir=$QT_SRC_DIR \
          --build-docs \
          --doc-build-online \
          --cmake-generator=Ninja \
          --ignore-git \
          --verbose
        
    - name: Build PySide6 modules
      run: |
        source venv/bin/activate
        # 单独构建模块，避免复杂的setup.py问题
        python setup.py build \
          --parallel=4 \
          --skip-docs \
          --ignore-git
        
    - name: Build API documentation
      run: |
        source venv/bin/activate
        cd build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6
        ninja -j4 apidoc
        
    - name: Build base documentation
      run: |
        source venv/bin/activate
        python setup.py build_base_docs
        
    - name: Archive HTML documentation
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-docs-html
        path: |
          html/
          build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/
        retention-days: 30
        
    - name: Archive QCH files
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-docs-qch
        path: |
          build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/PySide6.qch
          build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/shiboken6/doc/html/Shiboken6.qch
        retention-days: 30
        
    - name: Test documentation build
      run: |
        source venv/bin/activate
        # 检查主要文件是否存在
        if [ -f "html/pyside6/index.html" ]; then
          echo "Base documentation built successfully"
          ls -la html/pyside6/index.html
        else
          echo "Base documentation build failed"
        fi
        
        if [ -f "build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/index.html" ]; then
          echo "Full documentation built successfully"
          ls -la build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/index.html
        else
          echo "Full documentation build failed"
        fi
        
    - name: Create summary report
      run: |
        echo "### PySide6 Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Qt Version:** ${{ env.QT_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**PySide Version:** ${{ env.PYSIDE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Generated Artifacts:**" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Documentation (Base)" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Documentation (Full with API)" >> $GITHUB_STEP_SUMMARY
        echo "- QCH Files (Offline Help)" >> $GITHUB_STEP_SUMMARY
