name: Build PySide6 Documentation

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  QT_VERSION: '6.10.0'

jobs:
  build-documentation:
    name: Build PySide6 Docs
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: pyside/pyside-setup
        ref: 6.10
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libxml2-dev \
          libxslt1-dev \
          graphviz \
          libgl1-mesa-dev \
          libxkbcommon-x11-0 \
          libdbus-1-3 \
          pkg-config \
          libssl-dev \
          libglib2.0-dev
        
    - name: Create virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        
    - name: Install documentation requirements
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        # 安装文档要求
        pip install -r requirements-doc.txt || pip install sphinx sphinx-panels sphinx-rtd-theme graphviz
        
    - name: Download Qt source code
      run: |
        wget https://download.qt.io/official_releases/qt/6.10/$QT_VERSION/single/qt-everywhere-src-$QT_VERSION.tar.xz
        tar -xf qt-everywhere-src-$QT_VERSION.tar.xz
        echo "QT_SRC_DIR=$PWD/qt-everywhere-src-$QT_VERSION" >> $GITHUB_ENV
        
    - name: Build base documentation only
      run: |
        source venv/bin/activate
        python setup.py build_base_docs
        
    - name: Build full documentation (Base + API)
      run: |
        source venv/bin/activate
        # 首先构建 PySide6 并启用文档构建
        python setup.py build \
          --qt-src-dir=qt-everywhere-src-$QT_VERSION \
          --build-docs \
          --doc-build-online \
          --parallel=4 \
          --ignore-git
        
        # 然后构建 API 文档
        cd build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6
        ninja -j4 apidoc
        
    - name: Build example gallery
      run: |
        source venv/bin/activate
        python tools/example_gallery/main.py
        
    - name: Archive base documentation
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-base-docs
        path: html/
        retention-days: 30
        
    - name: Archive full documentation
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-full-docs
        path: build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/
        retention-days: 30
        
    - name: Archive QCH files
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-qch-files
        path: |
          build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/PySide6.qch
          build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/shiboken6/doc/html/Shiboken6.qch
        retention-days: 30
        
    - name: Test documentation
      run: |
        source venv/bin/activate
        echo "=== Testing Base Documentation ==="
        if [ -f "html/pyside6/index.html" ]; then
          echo "✓ Base documentation built successfully"
          ls -la html/pyside6/index.html
        else
          echo "✗ Base documentation missing"
        fi
        
        echo ""
        echo "=== Testing Full Documentation ==="
        if [ -f "build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/index.html" ]; then
          echo "✓ Full documentation built successfully"
          ls -la build/$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")/build/pyside6/doc/html/index.html
        else
          echo "✗ Full documentation missing"
        fi
        
    - name: Create summary report
      run: |
        echo "### PySide6 Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Qt Version:** ${{ env.QT_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Generated Documentation:**" >> $GITHUB_STEP_SUMMARY
        echo "- Base Documentation (HTML)" >> $GITHUB_STEP_SUMMARY
        echo "- Full Documentation with API (HTML)" >> $GITHUB_STEP_SUMMARY
        echo "- QCH Files for offline viewing" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Viewing Instructions:**" >> $GITHUB_STEP_SUMMARY
        echo "- Download artifacts and open `html/pyside6/index.html` in a browser for base docs" >> $GITHUB_STEP_SUMMARY
        echo "- Use Qt Assistant to view QCH files: `assistant -register PySide6.qch`" >> $GITHUB_STEP_SUMMARY
